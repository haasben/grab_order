<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>客户反馈列表</title>
    <link rel="stylesheet" href="/static/sadmin/frame/layui/css/layui.css">
    <link rel="stylesheet" href="/static/sadmin/frame/static/css/style.css">
    <script type="text/javascript" src="__SADMIN__js/jQuery1.9.1.js" ></script>
</head>
<style type="text/css">
  td{
    text-align: center;
  }

</style>
<!-- <a href='{:url("nagent/user/add_group")}' class="layui-btn layui-btn-small" style="margin:1% 0 0 1%">添加分组</a> -->
<table class="layui-table" style="border-collapse:collapse !important;border:1px solid #ccc">
  <colgroup>
    <col width="150">
    <col width="400">
    <col>
  </colgroup>
  <thead>
    <tr>
<!--       <th>序号</th> -->
      <th>客户用户名</th>
      <th>内容</th>
      <th>反馈时间</th>
      <th>未读信息</th>
      <th>操作</th>
    </tr> 
  </thead>
  <tbody>
    {volist name="$data" id="v"}
    <tr>
<!--       <td>{$key+1}</td> -->
       <td>{$v.group_id}</td>
       <td class="{$v.group_id}_chat">{$v.chat}</td>
       <td class="{$v.group_id}_date">{:date('Y-m-d H:i:s',$v['time'])}</td>
       <td class="{$v.group_id}">{$v.count_is_read}</td>

      <td> <a value="{$v.group_id}" val="" href="javascript:;" class="layui-btn chat_mag layui-btn-small" >点击回复</a></td>
    </tr>
    {/volist}
  </tbody>

</table>
{$data->render()}
  <style>
    .pagination li{
        display:inline-block;
    }
  
  </style>
<script type="text/javascript" src="/static/sadmin/frame/layui/layui.js"></script>
  <script>
    var ws = new WebSocket("ws://"+document.domain+":8282");

ws.onopen = function()
   {
      // Web Socket 已连接上，使用 send() 方法发送数据

      var data = '{"type":"bind","group_id":"admin"}';
      ws.send(data);
      var t2 = window.setInterval("hello()",5000); 

   };
function hello(){ 
  var data = '{"type":"ping"}';
  ws.send(data);
} 
  
// 服务端主动推送消息时会触发这里的onmessage
ws.onmessage = function(e){
    // json数据转换成js对象
    var data = JSON.parse(e.data);
    var type = data.type || '';
    switch(type){
        case 'ping':
                
            break;
        case 'receive_customer_add':
        	console.log(data.data.name);
        	var sum = $('.'+data.data.name).text();
        	var sum =  parseInt(sum)+1;
        	console.log(sum);
        	$('.'+data.data.name).text(sum);
        	//$('.'+data.name+'_date').text()
        	$('.'+data.data.name+'_chat').text(data.data.chat);

          break;

        case 'receive_customer_less':
            $('.'+data.data.name).text(0);
          break;
        default :
        
            console.log(e.data);
    }
};

ws.onclose = function(){

    console.log('链接关闭');
  
}



    layui.use(['form','layer'], function(){
        var form = layui.form
            ,layer = layui.layer
            ,layedit = layui.layedit
            ,laydate = layui.laydate
            ,layer = layui.layer;
  
    $('.chat_mag').click(function(){

        layer.closeAll();

        var name = $(this).attr('value');
        layer.open({
        type: 2,
        title: '用户管理',
        shadeClose: true,
        shade: false,
        maxmin: true, //开启最大化最小化按钮
        area: ['40%','50%'],
        content: '{:url("Customer/Customer/index")}?customer=1415&id=999&name='+name
      });
    })  
  })

</script>
