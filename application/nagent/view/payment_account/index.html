{include file="common/head"}
<body class="body">
<link rel="stylesheet" href="/static/layui/css/layui.css">
<form class="layui-form layui-form-pane" action="/nagent/Payment_account/index.html">
    
    <div class="layui-form-item">
      <div class="layui-inline">
            <div class="layui-input-inline">
                <input type="text" name="name" class="layui-input" placeholder="账户名称或设备号">
            </div>
        </div>
        <div class="layui-inline">
            <div class="layui-input-inline">
                <input type="text" name="start_time" id="date1" autocomplete="off" class="layui-input" placeholder="开始时间">
            </div>
        </div>
        <div class="layui-inline">
            <div class="layui-input-inline">
                <input type="text" name="end_time" id="date" autocomplete="off" class="layui-input" placeholder="结束时间">
            </div>
        </div>
        <div class="layui-inline">
          <div class="layui-input-inline">
            <select name="type" >
               <option value="">请选择通道类型</option>
        {volist name="$channel" id="cv"}
              <option value="{$cv.id}">{$cv.channel_name}</option>
        {/volist}

            </select>
          </div>
        </div>
        <div class="layui-inline">
          <div class="layui-input-inline">
            <select name="group_id" lay-search >
              <option value="">全部分组</option>
              {volist name="$group_name" id="g"}
              <option value="{$g.id}">{$g.group_name}</option>
              {/volist}
            </select>
          </div>
        </div>
      
      	<div class="layui-inline">
          <div class="layui-input-inline">
            <select name="clerk_id" lay-search>
              <option value="">全部店员</option>
              {volist name="$quotient" id="q"}
              	<option value="{$q.app_id}">{$q.name}</option>
              {/volist}

            </select>
          </div>
        </div>

       <div class="layui-inline">
         <button style="background-color: #1E9FFF;" class="layui-btn layui-btn-sm" lay-submit="" lay-filter="demo2">确定</button>
      </div>

      <div class="layui-inline">
        <a style="background-color: #009688;" href="/nagent/payment_account/add_code" class="layui-btn layui-btn-normal layui-btn-sm">添加收款账户</a>
      </div>
      
      <div class="layui-inline">
        <a href="/apk/hook.apk" class="layui-btn layui-btn-danger layui-btn-sm" type="button">软件下载</a>
      </div>
    </div>
  <div class="layui-form-item">
    <div class="layui-inline">
      <a class="layui-btn open layui-btn-sm" href="javascript:;">开启账号</a>
    </div>
    <div class="layui-inline">
      <a class="layui-btn close layui-btn-sm" href="javascript:;">关闭账号</a>
    </div>
	<div class="layui-inline">
             <a class="layui-btn  management layui-btn-sm" href="javascript:;">分组管理</a>
      </div>
    <div class="layui-inline">
      <a href="javascript:;" onclick="get_money(1)" class="layui-btn layui-btn-sm">今日收款</a>
    </div>
    <div class="layui-inline">
      <a href="javascript:;" class="layui-btn layui-btn-sm" onclick="get_money(2) layui-btn-sm">昨日收款</a>
    </div>
  </div>
</form>
  



<!-- <fieldset class="layui-elem-field layui-field-title" style="display: block">
  <legend>总金额<span class="account_money">{$sum_money/100}</span>元</legend>
</fieldset> -->
<style type="text/css">
  th{
  	border:1px solid #ccc !important;
    text-align: left !important;
    padding-left:10px !important;
    font-weight:bold !important;
  }
    td{
        text-align: left;
        padding-left:10px !important;
      	border:1px solid #ccc !important;
      color:#4d4d4d !important;
    }


</style>

<form class="layui-form" action="">
<table class="layui-table" style="border-collapse:collapse !important;border:1px solid #ccc;">
   <colgroup>
        <col width="50">
        <col>
        <col>
     
        <col>
    </colgroup>
    <thead>
    <tr class="table_tr">
        <th><input name="Fruit" id="Fruit" lay-filter="all_Fruit" class="all_Fruit " type="checkbox" value="" style=""/></th>
        <th>编号</th>
        <th>收款号</th>
        <th>账号类型</th>
      	 <th>所属分组</th>
        <th><a href="/nagent/Payment_account/index.html?order=withdrawal_sum">总收款</a></th>
        <th>今日收款</th>
<!--         <th>累计手续费</th>
        <th>累计提现</th>
        <th><a href="/nagent/Payment_account/index.html?order=money">当前余额</a></th> -->
      	<th>成功率</th>
      	<th>收单率</th>
        <!--<th>收款人</th>-->
        <th>设备号</th>
      	<th>在线时间</th>
      	<th>子集</th>
        <th>状态</th>
        <th>是否店员</th>
      	<th>低金额模式</th>
        <th>操作</th>
    </tr>

    </thead>
    <tbody>


    <?php $arr_id = '';?>
      
      
    {volist name="secret_key_data" id="vo"}
      
     {if condition="$vo.app_id != ''"}
      	
      	<?php $arr_id .= '"'.$vo['app_id'].'"'.','; ?>
      
      
     {/if}
    <tr class="receivables_data">
        
        <td><input name="Fruit" class="Fruit" type="checkbox" value="{$vo.id}" /></td>
        <td>{$i}</td>
        <td>{$vo.name}</td>
        <td>{$vo.show_name}</td>
      	<td>{$vo.group_name}</td>
        <td>{$vo.recharge_sum/100}</td>
        <td><font color=red>( <b>{$vo.today_succ_count} / {$vo.today_count}</b> ) {$vo.sum_amount/100}</font></td>
<!--         <td>{$vo.fee_sum/100}</td>
        <td>{$vo.withdrawal_sum/100}</td>
        <td>{$vo.money/100}</td> -->
      	<td >{if condition="$vo.count == 0"}100{else}
   
          {if condition="$vo.succ_count/$vo.count*100 >= 50"}<span>
          
          {else}<span style="color:red"></span>
          {/if}
          {:round($vo.succ_count/$vo.count,4)*100}
          
          {/if}%</td>
         <td>{$vo.succ_count}/{$vo.count}</td>
       <!-- <td>{:explode('|',$vo.receive_account)[0]}</td>-->
        <td>{:substr($vo['app_id'],20,8)}</td>
          <td>
          <?php  if($vo['is_platform'] == 1){
            $time = time() - cache('DeviceNo'.$vo['app_id']);

            if($time < 5 ){
                 $msg = '<sapn style="color:green;">'.$time.' 秒前在线 ●';
            }elseif($time>5 && $time<180){
                 $msg = '设备掉线<b style="color:orange;">'.($time-5).'</b>秒';

            }else{
                $msg = '<sapn style="color:#999;">设备离线</span>';
            }
			$app_id = $vo['app_id'];
			echo '<span class="'.$app_id.'">'.$msg.'</span>';

		
        };?>
          
          </td>

         <td>{$vo.count_img}</td>
        <td>
          {if condition="$vo.is_clerk == 1"}
              店员号不收款

          {else}
          <input type="checkbox" name="is_lock" value="{$vo.id}" lay-skin="switch" lay-text="on|off" lay-filter="is_lock" {if condition="$vo.status == 1"}checked{/if}>
          {/if}
        </td>

        <td>
          {if condition="$vo.is_clerk == 2"}
            {$vo.clerk}

          {else}
          <input type="checkbox" name="is_clerk" value="{$vo.id}" lay-skin="switch" lay-text="是|否" lay-filter="is_clerk" {if condition="$vo.is_clerk == 1"}checked{/if}>

          {/if}
        </td>
		 <td>
          <input type="checkbox" name="low_mode" value="{$vo.id}" lay-skin="switch" lay-text="on|off" lay-filter="low_mode" {if condition="$vo.low_mode == 1"}checked{/if}>
      </td>
        <td>
          {if condition="$vo.type != 1032"}
          {if condition="$vo.is_clerk == 0"}
          <a href="javascript:;"  class="layui-btn layui-btn-sm bind_clerk" lay-submit="" lay-filter="" value="{$vo.id}"> 绑定店员</a>
          {elseif condition="$vo.is_clerk == 2"}
          <a href="javascript:;"  class="layui-btn layui-btn-sm layui-btn-danger lift_clerk" lay-submit="" value="{$vo.id}" lay-filter=""> 解除店员</a>
          {else}
          
          {/if}
          {if condition="$vo.is_clerk != 1"}
          <a href="/nagent/payment_account/add_qrcode?id={$vo.id}"  class="layui-btn layui-btn-normal layui-btn-sm" lay-submit="" lay-filter="">加码</a>

          <a href="javascript:;"  class="layui-btn layui-btn-normal layui-btn-sm qrcode" value="{$vo.id}" lay-submit="" lay-filter=""> 二维码</a>
          {/if}
          {/if}
		   <a value="{$vo.id}"  class="layui-btn layui-btn-normal edit_account layui-btn-sm" lay-submit="" lay-filter=""> 编辑</a>
          
           <a value="{$vo.id}"  class="layui-btn layui-btn-danger del_account layui-btn-sm" lay-submit="" lay-filter=""> 删号</a>

        </td>
      
    </tr>
    {/volist}
</form>
    </tbody>
</table>

{$secret_key_data->render()}

<script type="text/javascript" src="/static/layui/layui.js"></script>
<script>
  	
  	 var arr_id = new Array({$arr_id});
 
       setInterval(function () {
         	
         if (arr_id.length != 0) {

           	$.post('{:url("nagent/payment_account/get_cache")}',{data:arr_id},function(data){
            	
              	if(data.code == '0000'){
                	
                  	 $.each(data.data,function(i,item){
						
                       	$('.'+i).html(item);
              		});
                }
            })
        }

      }, 6000);
  



layui.use(['form', 'layedit', 'laydate'], function(){
        var form = layui.form
            ,layer = layui.layer
            ,layedit = layui.layedit
            ,laydate = layui.laydate;

        //日期
        laydate.render({
            elem: '#date'
            ,type: 'datetime'
        });
        laydate.render({
            elem: '#date1'
          ,type: 'datetime'
        });

//绑定店员
  $('.bind_clerk').click(function(){

      var id = $(this).attr('value');

      layer.open({
        type: 2,
        title: '分组管理',
        shadeClose: true,
        shade: false,
        maxmin: true, //开启最大化最小化按钮
        area: ['60%', '60%'],
        content: '{:url("nagent/paymentAccount/bind_clerk")}?id='+id
      });

})

  $('.qrcode').click(function(){

      var id = $(this).attr('value');
      $.post('{:url("nagent/paymentAccount/get_qrcode")}',{id:id}, function(data){

          if(data.code == '0000'){
              layer.photos({
                photos: data.json //格式见API文档手册页
                ,anim: 1 //0-6的选择，指定弹出图片动画类型，默认随机
            });

          }else{
              layer.msg(data.msg,{icon:5,time:1500});

          }   
    });
})
//解除店员
$('.lift_clerk').click(function(){


    var id = $(this).attr('value');
    layer.confirm('确定要解除店员吗？？', {
              btn: ['确定','取消'] //按钮
            }, function(){

    

    $.post('{:url("nagent/payment_account/lift_clerk")}',{id:id},function(data){

          if(data.code == '0000'){
              layer.msg(data.msg,{icon:1,time:1000},function(){

                location.reload();

              });
          }else{
              layer.msg(data.msg,{icon:5,time:1500});
          }

  })


})

})






    form.on('switch(is_lock)', function(data){
        var id = data.value;
        var checked = data.elem.checked;
        $.post('{:url("nagent/payment_account/update_status")}',{id:id,status:checked},function(data){

                if(data.success == '1'){
                    layer.msg(data.hint,{icon:1,time:1000});
                }else{
                    layer.msg(data.hint,{icon:5,time:1000});
                }



        })

    });
  
 //开启关闭低收款模式
      form.on('switch(low_mode)', function(data){
        var id = data.value;
        var checked = data.elem.checked;
        $.post('{:url("nagent/payment_account/low_mode")}',{id:id,status:checked},function(data){

                if(data.success == '1'){
                    layer.msg(data.hint,{icon:1,time:1000});
                }else{
                    layer.msg(data.hint,{icon:5,time:1000});
                }



        })

    });

    form.on('switch(is_clerk)', function(data){

      layer.confirm('修改后会改变设备号,确认要修改吗？？', {
              btn: ['确定','取消'] //按钮
            }, function(){


        var id = data.value;
        var checked = data.elem.checked;
        var this_eme = $(this);
        $.post('{:url("nagent/payment_account/update_clerk")}',{id:id,status:checked},function(data){

                if(data.code == '0000'){
                    layer.msg(data.msg,{icon:1,time:1000},function(){

                      location.reload();

                    });
                }else{
                    layer.msg(data.msg,{icon:5,time:1500},function(){

                        if(checked){
                          this_eme.removeAttr('checked');
                        }else{
                          this_eme.attr('checked','checked');
                        }
                        form.render();

                    });
                }

        })

    })
   });
//iframe窗
$('.edit_account').click(function(){

    var id = $(this).attr('value');

      layer.open({
        type: 2,
        title: '分组管理',
        shadeClose: true,
        shade: false,
        maxmin: true, //开启最大化最小化按钮
        area: ['60%', '60%'],
        content: '{:url("nagent/paymentAccount/edit_account")}?id='+id,
      });



})


    
//iframe窗
$('.management').click(function(){


      layer.open({
        type: 2,
        title: '分组管理',
        shadeClose: true,
        shade: false,
        maxmin: true, //开启最大化最小化按钮
        area: ['70%', '70%'],
        content: '{:url("nagent/paymentAccount/group_management")}'
      });



})
      form.on('checkbox(all_Fruit)', function(data){

        //2.获取选中状态
        var checkedElt=data.elem.checked;
        //3.若checked=true,将所有的复选框选中,checked=false,将所有的复选框取消
        var allCheck=$('.Fruit');
        if(checkedElt){

      //全选
        for(var i=0;i<allCheck.length;i++){
        //设置复选框的选中状态
          allCheck[i].checked=true;
          }

        }else{
        //取消全选
        for(var i=0;i<allCheck.length;i++){
          allCheck[i].checked=false;
          }

          }

          form.render();
        })




        //监听提交
        form.on('submit(demo1)', function(data){
            layer.alert(JSON.stringify(data.field), {
                title: '最终的提交信息'
            });
            return false;
        });


$('.open').click(function(){


  var id = document.getElementsByName('Fruit');
            var value = new Array();
            for(var i = 0; i < id.length; i++){
             if(id[i].checked)
     
              if(id[i].value != ""){
                value.push(id[i].value);
              }
             
            }
      if(value == ''){

        layer.msg('请至少选择一个需要开启的账户', {icon: 5,time:1500});
      }else{

        $.post('{:url("nagent/paymentAccount/open_account")}',{value},function(data){

            if(data.code == '0000'){

              layer.msg(data.msg, {icon: 1,time:1000},function(){

                  location.reload();

              });
            }else{
              layer.msg(data.msg, {icon: 5,time:1000});
            }



        })


      }


})
$('.close').click(function(){


  var id = document.getElementsByName('Fruit');
            var value = new Array();
            for(var i = 0; i < id.length; i++){
             if(id[i].checked)
     
              if(id[i].value != ""){
                value.push(id[i].value);
              }
             
            }
      if(value == ''){

        layer.msg('请至少选择一个需要关闭的账户', {icon: 5,time:1500});
      }else{

        $.post('{:url("nagent/paymentAccount/close_account")}',{value},function(data){

            if(data.code == '0000'){
              layer.msg(data.msg, {icon: 1,time:1000},function(){
                  location.reload();

              });
            }else{
              layer.msg(data.msg, {icon: 5,time:1000});
            }
        })
      }
})

});

    function get_money(type){

    $.post('{:url("nagent/payment_account/get_money")}',{dayType:type},function(data){
      if(data.code == '0000'){
        $('.account_money').text(data.data);
      }


    })

}
</script>
<script type="text/javascript">
  
  $('.operation').click(function(){
        var status = $(this).attr('status');
        var id = $(this).attr('value');
        if (status==1) {
            var msg = "确定禁用";
    
        }else{
          var msg = '确认开启';

        }
         layer.confirm(msg+'此账号？？', {
              btn: ['确定','取消'] //按钮
            }, function(){
              $.ajax({
                  url:'/nagent/Payment_account/update_status.html',
                  data:{
                      status:status,
                      id:id,
                  },
                  type:'get',
                  dataType:'json',
                  success:function(data){
                    
                    layer.msg(data.hint, {icon: 1,time:1000},function(){
                      location.reload();
                    
                    });
                      
                  }
              })
         });
          

    })
  
//删除收款账号
      $('.del_account').click(function(){
          
      var var_this = $(this);
          var id = $(this).attr('value');
          layer.confirm('删除不可恢复,确定删除吗？？', {
              btn: ['确定','取消'] //按钮
            }, function(){
              
              $.ajax({
                  url:'/nagent/Payment_account/del_account.html',
                  data:{
                      id:id,
                  },
                  type:'get',
                  dataType:'json',
                  success:function(data){
                    if(data.success == 1){
                      var_this.parents('tr').remove();
                      layer.msg(data.hint, {icon: 1,time:1000});
                    }else{
                      layer.msg(data.hint, {icon: 5,time:1000});
                    }
                    
                  }
              })
          })
  });

  //下账
      $('.debit').click(function(){
      var id = $(this).attr('value');
        
            layer.prompt({title: '输入下账口令，并确认', formType: 1}, function(pass, index){
              layer.close(index);
              layer.prompt({title: '请输入下账的金额，单位元', formType: 4}, function(text, index){

                    $.post('{:url("sadmin/payment_account/debit_money")}',{pass:pass,money:text,id:id},function(data){

                        if(data.code == '0000'){

                            layer.close(index);
                            layer.msg(data.msg,{icon: 1,time:2000},function(){
                                    location.reload();
                                });
                        }else{

                            layer.msg(data.msg);

                        }

                    })
              });
            });

        })
</script>
</body>
</html>