{include file="common/head"}
<body class="body">

<form class="layui-form" action="/nagent/Recharge/index.html">
    <div class="layui-form-item">
        <div class="layui-inline">
            <div class="layui-input-inline">
                <input type="text" name="uid"  value="{:input('get.uid')}" autocomplete="off" class="layui-input" placeholder="商户编号">
            </div>
        </div>
        <!--<div class="layui-inline">
            <div class="layui-input-inline">
                <input type="text" name="order_num" value="{:input('get.order_num')}"  autocomplete="off" class="layui-input" placeholder="商户单号">
            </div>
        </div>-->
        <div class="layui-inline">
            <div class="layui-input-inline">
                <input type="text" name="id" value="{:input('get.id')}"  autocomplete="off" class="layui-input"  placeholder="机构单号">
            </div>
        </div>
        <!--<div class="layui-inline">
            <div class="layui-input-inline">
                <input type="text" name="trade_no" value="{:input('get.trade_no')}"  autocomplete="off" class="layui-input" placeholder="流水号">
            </div>
        </div>-->
  
        <div class="layui-inline">
            <div class="layui-input-inline">
                <select name="pay_status" lay-search="">
                    <option value="">订单状态</option> -->
                    <option value="0">全部</option>
                    <option value="1">已支付</option>
                    <option value="2">未支付</option>
                   
                </select>
            </div>
        </div>
      
        <div class="layui-inline">
            <div class="layui-input-inline">
                <select name="notify_url_info" lay-search="">
                    <option value="">回调状态</option>
                    <option value="全部">全部</option>
                    <option value="0">未触发</option>
                    <option value="1">success</option>
                    <option value="2">fail</option>
                    <option value="3">参数错误</option>
                </select>
            </div>
        </div>
      
        <div class="layui-inline">
            <div class="layui-input-inline">
                <select name="pay_type"  lay-search="" >
                    <option value="">收款账户</option>
                    {volist name="top_account_assets" id="vo"}
                            <option value="{$vo.id}">{$vo.name}</option>
                    {/volist}
                </select>
            </div>
        </div>
      	<div class="layui-inline">
            <div class="layui-input-inline">
                <select name="channel_id"  lay-search="" >
                    <option value="">通道类型</option>
                    {volist name="$channel_data" id="vo"}
                            <option value="{$vo.taid}">{$vo.channel_name}</option>
                    {/volist}
                </select>
            </div>
        </div>
      
        <div class="layui-inline">
            <div class="layui-input-inline">
                <input type="text" name="start_time" id="date" lay-verify="date" placeholder="开始日期" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-inline">
            <div class="layui-input-inline">
                <input type="text" name="end_time" id="date1" lay-verify="date" placeholder="结束日期" autocomplete="off" class="layui-input">
            </div>
        </div>
      <div class="layui-inline">
            <div class="layui-input-inline">
                 <button type="submit" class="layui-btn">查询</button>
                 <button type="reset" class="layui-btn layui-btn-warm" >取消</button>
            </div>
        </div>
  </div>
</form>
<style type="text/css">
  th{
  	border:1px solid #ccc !important;
  }
    td{
        text-align: center;
      	border:1px solid #ccc !important;
		padding:0 !important;
      color:#666;
      	
    }
  tr{
  		height:38px !important;
  }


</style>


<table class="layui-table" style="border-collapse:collapse !important;border:1px solid #ccc">
    <thead>
    <tr>

        <th>订单号</th>
        <th>生成时间</th>
        <th>支付时间</th>
        <th>订单状态</th>
        <th>金额</th>
        <th>收款账户</th>
 		<th>通道类型</th>
        <th>回调状态</th>
        <th>通知次数</th>
      	<th>备注</th>
        <th>操作</th>
    </tr>
    </thead>
    <tbody>

    {volist name="order_data" id="vo"}
<?php

if($vo['notify_url_info']==1){
    $vo['notify_url_info'] = "success";
}elseif($vo['notify_url_info']==2){
    $vo['notify_url_info'] = "fail";
}elseif($vo['notify_url_info']==3){
    $vo['notify_url_info'] = "返回参数错误";
}elseif($vo['notify_url_info']==0){
    $vo['notify_url_info'] = "未触发";
}

$vo['ext'] = $vo['ext']==null?'&nbsp;':$vo['ext'];
?>  
    <tr>
   
        <td><ul>
            <li>{$vo.merchant_cname}_{$vo.id}</li>
<!--             <li>下级单号&nbsp;:&nbsp;{$vo.order_num}</li> -->

        </ul></td>
        <td> <ul style="">
            <li>{:date('Y-m-d H:i:s',$vo.accept_time)}</li>

        </ul></td>

         <td> <ul style="">
            <li>
                <?php
                    if($vo['pay_time']==0){
                        echo "未支付";
                    }else{
                        echo date('Y-m-d H:i:s',$vo['pay_time']);
                    }
                    ?></li>
        </ul></td>


        <td><?php
                if($vo['pay_status']==1){
                    echo "支付成功";
                }elseif($vo['pay_status']==3){
                    echo "支付失败";
                }else{
                    echo "未支付";
                }
                ?></td>
        <td><ul style="">
            <li>{$vo.pay_amount/100}</li>

            
        </ul></td>

        <td><ul style="">

            <li>{$vo.name}</li>
            
        </ul></td>
 		
      	<td><ul style="">

            <li>{$vo.channel_name}</li>
            
        </ul></td>
      

        <td><ul>
            <li>{$vo.notify_url_info}</li>
            
        </ul></td>
        <td> <ul>
            <li>{$vo.notice_num}</li>
        </ul></td>
      
      	<td> <ul>
            <li>{$vo.ext}</li>
        </ul></td>

        <td>
            <ul>
                <li>

                <?php
                    if($vo['order_type']==1){
                ?>  
                   
					{if condition="$vo.pay_status == 2"}
                   

                            {if condition="$vo.type == 1032"}
                                <a href="{:url('nagent/chat/index',['orderId'=>$vo['id']])}" class="reissue-notice layui-btn layui-btn-normal" style="font-size: 50%;line-height: 30px;height: 30px;"><b>立即进入对话模式→</b></a>

                            {else}
                                <button value="{$vo.id}" class="reissue-notice layui-btn layui-btn-danger repeat_no_adjusted" style="font-size: 50%;line-height: 30px;height: 30px;background-color:#ff0000;"><b>确认此订单已收款 ?</b></button>
                            {/if}
					  {elseif condition="$vo.pay_status == 3"}
                        		<button class="layui-btn layui-btn-small" style="background-color:#d1e0e0;color:#999999;text-decoration:line-through;">订单已作废</button>
                      {else}
                                 <button value="{$vo.id}" class="reissue-notice layui-btn repeat_notify_url" style="font-size: 50%;line-height: 30px;height: 30px;">补发通知</button>
						
						 {/if}
                       
                   
                <?php
                };?>

                </li>
            </ul>
        </td>
    </tr>
{/volist}
    </tbody>
    
</table>
{$order_data->render()}
  <style>
    .pagination li{
        display:inline-block;
    }
  
  </style>
<script type="text/javascript">
$(function(){
    
    $('.repeat_no_adjusted').click(function(){
    
         var msg = "确定已收到款并给下级回调？";
          if (confirm(msg)==true){
              var id = $(this).attr('value');
              $.ajax({
                  url:'/api/Notify/edit_order.html',
                  data:{
                      id:id,
                      uid:{$login_user.id}
                  },
                  type:'get',
                  dataType:'html',
                  success:function(data){

                      alert('确认付款成功，商户返回：'+data);

                      location.reload();
                  }
              })
          }
    
    
    })
  
  

    $('.repeat_notify_url').click(function(){
        if ($(this).parents('tr').find('.order_num').text()=="提现"||$(this).parents('tr').find('.order_num').text()=="提现单作废") {
            alert('提现订单，无补发地址');
            return false;
        }
        
        if ($(this).parents('tr').find('.pay_time').text()=="未支付") {
            alert('订单未付款，无法补发');
            return false;
        }


        var msg = "确定补发通知？";
        if (confirm(msg)==true){
            var id = $(this).attr('value');
            $.ajax({
                url:'/api/Notify/repeat_notify_url.html',
                data:{
                    id:id
                },
                type:'get',
                dataType:'html',
                success:function(data){

                    alert('补发成功，商户返回：'+data);

                    location.reload();
                }
            })
        }
    })
})
</script>
<script type="text/javascript" src="/static/sadmin/frame/layui/layui.js"></script>
<script>
    layui.use(['form', 'layedit', 'laydate'], function(){
        var form = layui.form
            ,layer = layui.layer
            ,layedit = layui.layedit
            ,laydate = layui.laydate;

        //日期
        laydate.render({
            elem: '#date'
          ,type: 'datetime'
        });
        laydate.render({
            elem: '#date1'
          ,type: 'datetime'
        });

        //监听提交
        form.on('submit(demo1)', function(data){
            layer.alert(JSON.stringify(data.field), {
                title: '最终的提交信息'
            });
            return false;
        });


    });
</script>
</body>
</html>