<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>红云支付线上管理系统</title>
		<link rel="stylesheet" href="__ADMIN__css/index2.css" />
		
	</head>
	<style>
		td,th{
				white-space: nowrap;/*不换行*/
			}
			tr:nth-child(even){
				background: #e5f0f3;
			}
			.ext{
				display: inline-block;   
			    white-space: nowrap;
			    width: 250px;
			    border:none;
			    border-bottom: 1px solid #ccc;
			    overflow: hidden;
			}
	</style>
	<body>
	<div class="box">
{include file="common/header" /}
		<div class="content">
{include file="common/left" /}
		<div class="content_right">
		<form action="/admin/Recharge/index.html">

		<div class="input_group">
		商户单号：<input value="{:input('get.order_num')}" type="text" name="order_num">
		</div>
		
		<div class="input_group">
		开始时间：<input type="datetime-local" value="" name="start_time" style="width: 180px;">
		</div>
		<div class="input_group">
		结束时间：<input type="datetime-local" name="end_time" style="width: 180px;">
		</div>
	

		<div class="input_group">
		订单状态：<select name="pay_status">
		<option value="1">已支付</option>
		<option value="2">未支付</option>
		<option value="0">全部</option>
		</select>
		</div>

		<div class="input_group">
		回调状态：<select name="notify_url_info">
		<option>全部</option>
		<option value="0">未触发</option>
		<option value="1">success</option>
		<option value="2">fail</option>
		<option value="3">参数错误</option>
		</select>
		</div>

		<div class="input_group">
		<button  style="color: white;">确定</button>
		</div>
	
		<div class="input_group">

		</div>

		<div class="input_group">
		<a href="/admin/Recharge/index.html?{$get_srt}excel=1"><button type="button" style="color: white;width: 20%">导出表格</button>
		</a>
		</div>

		</form><br/>
          
<div style="position: absolute;">
        
		<div class="zong">
		充值记录数：<span style="color: red;font-size: 200%">{$list_number}</span>条&nbsp;
		总额:<span id="sum_money">{$sum_amount/100}</span>元</div>

		<table>
		<thead>


		 <th style="width: 3%;">机构单号</th>
		<th>商户单号</th>
		<th>支付方式</th>
		<th>生成时间</th>
		<th>支付时间</th>
		<th>付款金额</th>
		<th>手续费</th>
		<th>订单状态</th>
		<th>账户余额</th>
		<th>商户回调状态</th>
		<th>通知次数</th>
		<th style="width:10%">订单备注</th>
		<th>操作</th>
		
		</thead>
		

{volist name="order_data" id="vo"}
<?php
if($vo['order_type']==1){
	$vo['pay_status'] = $vo['pay_status']==1?"支付成功":"未支付";
}else{
	$vo['pay_status'] = $vo['pay_time']==0?"已提交":"交易完成";
}

if($vo['notify_url_info']==1){
	$vo['notify_url_info'] = "success";
}elseif($vo['notify_url_info']==2){
	$vo['notify_url_info'] = "fail";
}elseif($vo['notify_url_info']==3){
	$vo['notify_url_info'] = "返回参数错误";
}elseif($vo['notify_url_info']==0){
	$vo['notify_url_info'] = "未触发";
}
$vo['pay_amount'] = $vo['order_type']==1||$vo['note_ext']=='退款'?$vo['pay_amount']:-$vo['pay_amount'];


$vo['ext'] = $vo['ext']==null?'&nbsp;':$vo['ext'];
?>
		<tr>
		<td>{$login_user.merchant_cname}_{$vo.id}</td>
		<td class="order_num">{$vo.order_num}</td>
		<td>{$vo.show_name} {$vo.note_ext}</td>
		<td style="font-size: 100%;font-weight: 500">{:date('Y-m-d H:i:s',$vo.accept_time)}</td>
		<td class="pay_time" style="font-size: 100%;font-weight: 500""><?php
if($vo['pay_time']==0){
	echo "未支付";
}else{
	echo date('Y-m-d H:i:s',$vo['pay_time']);
}
?></td>
		<td>{$vo.pay_amount/100}</td>
		<td>{$vo.this_fee/100}</td>
		<td>{$vo.pay_status}</td>
		<td>{$vo.this_money/100}</td>
		<td>{$vo.notify_url_info}</td>
		<td>{$vo.notice_num}</td>
		<td title="{$vo.ext}" class="ext">{$vo.ext}</td>
		<td>
<?php
if($vo['pay_time']==0&&time()-$vo['accept_time']>36000){
?>
			<button value="{$vo.id}" class="del_order" style="font-size: 50%;color: #fff;background-color: #ea6d59;line-height: 23px;height: 25px;">删除订单</button>
<?php
}elseif($vo['pay_time']>1&&$vo['order_type']==1){
?>
			<button value="{$vo.id}" class="repeat_notify_url" style="font-size: 50%;color: #fff;line-height: 23px;height: 25px;">补发通知</button>
<?php
}?>

		</td>
		</tr>	
{/volist}

<script type="text/javascript">
$(function(){
	$('input[name="start_time"]').val("{:input('get.start_time')}");
	$('input[name="end_time"]').val("{:input('get.end_time')}");
	
{volist name="get_select_data" id="vo"}
	$("select[name={$key}]").find("option[value={$vo}]").attr('selected','selected');
{/volist}

	$('.repeat_notify_url').click(function(){
		if ($(this).parents('tr').find('.order_num').text()=="提现") {
			alert('提现订单，无补发地址');
			return false;
		}
		if ($(this).parents('tr').find('.pay_time').text()=="未支付") {
			alert('订单未付款，无法补发');
			return false;
		}
		var msg = "确定补发通知？";
		if (confirm(msg)==true){
			var id = $(this).attr('value');
			$.ajax({
				url:'/api/Notify/repeat_notify_url.html',
				data:{
					id:id
				},
				dataType:'html',
				success:function(data){

					alert('补发成功，商户返回：'+data);

					location.reload();
				}
			})
		}
	})

	$('.del_order').click(function(){
		var msg = "确定删除订单？";
		if (confirm(msg)==true){
			var id = $(this).attr('value');
			$.ajax({
				url:'/admin/Recharge/del_order.html',
				data:{
					id:id
				},
				type:'post',
				dataType:'html',
				success:function(data){
					// console.log(data);return ;
					alert(data);
					location.reload();
				}
			})
		}
	})
})
</script>
		</table>
        {$order_data->render()}
</div>
		</div>
     

		</div>
		</div>

		
		
		<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
             <br/><br/>
			请进入机构信息页面修改
            <br/><br/>
			</div>
		</div><!-- /.modal-content -->
	</div>
	</body>
</html>